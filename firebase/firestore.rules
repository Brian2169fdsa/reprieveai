rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // User documents - users can read/write their own data
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Goals subcollection - users can manage their own goals
      match /goals/{goalId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Check-ins subcollection - users can manage their own check-ins
      match /checkins/{checkinId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Posts - public read, authenticated write (controlled by Cloud Functions)
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false; // Use Cloud Functions only
    }

    // Messages - users can read their own messages
    match /messages/{messageId} {
      allow read: if request.auth != null &&
                     (resource.data.fromUserId == request.auth.uid ||
                      resource.data.toUserId == request.auth.uid);
      allow create: if request.auth != null;
      allow update, delete: if false; // Use Cloud Functions only
    }

    // Invites - public read for verification
    match /invites/{inviteId} {
      allow read: if true;
      allow write: if false; // Admin only via Cloud Functions
    }

    // Invite requests - anyone can create, admin manages
    match /inviteRequests/{requestId} {
      allow read: if false;
      allow create: if true;
      allow update, delete: if false;
    }

    // Moderation reports - authenticated users can create
    match /moderationReports/{reportId} {
      allow read: if false; // Admin only
      allow create: if request.auth != null;
      allow update, delete: if false;
    }

    // Everything else - deny by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
